# 中サイズのテキストが PostgreSQL のパフォーマンスに与える驚くべき影響

次の記事のトレースをします

https://hakibenita.com/sql-medium-text-performance

次の３つのデータにおけるパフォーマンスについて測定します

- 小さなテキスト

- 大きなテキスト

- 中テキスト

### Toast の確認

```sql
sample=# CREATE TABLE toast_test (id SERIAL, value TEXT);
CREATE TABLE
sample=# SELECT relname, reltoastrelid FROM pg_class WHERE relname = 'toast_test';
  relname   | reltoastrelid
------------+---------------
 toast_test |         16390
(1 row)

sample=# SELECT relname FROM pg_class WHERE oid = 16390;
    relname
----------------
 pg_toast_16386
(1 row)

sample=#  \d pg_toast.pg_toast_16386
TOAST table "pg_toast.pg_toast_16386"
   Column   |  Type
------------+---------
 chunk_id   | oid
 chunk_seq  | integer
 chunk_data | bytea
Owning table: "public.toast_test"
Indexes:
    "pg_toast_16386_index" PRIMARY KEY, btree (chunk_id, chunk_seq)

sample=# SELECT * FROM pg_toast.pg_toast_16386;
 chunk_id | chunk_seq | chunk_data
----------+-----------+------------
(0 rows)
```

小さいテキストを挿入

```sql
sample=# INSERT INTO toast_test (value) VALUES ('small value');
INSERT 0 1
sample=# SELECT * FROM pg_toast.pg_toast_16386;
 chunk_id | chunk_seq | chunk_data
----------+-----------+------------
(0 rows)
```

toast はまだ空です。
大きいテキスト(4096 文字)を挿入  
まずは文字列生成関数を用意します

```sql
CREATE OR REPLACE FUNCTION generate_random_string(
  length INTEGER,
  characters TEXT default '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'
) RETURNS TEXT AS
$$
DECLARE
  result TEXT := '';
BEGIN
  IF length < 1 then
      RAISE EXCEPTION 'Invalid length';
  END IF;
  FOR __ IN 1..length LOOP
    result := result || substr(characters, floor(random() * length(characters))::int + 1, 1);
  end loop;
  RETURN result;
END;
$$ LANGUAGE plpgsql;
```

```sql
sample=# INSERT INTO toast_test (value)
(generate_random_string(4096));
INSERT 0 1

sample=# SELECT * FROM pg_toast.pg_toast_16386;
-[ RECORD 1 ]----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
chunk_id   | 16392
chunk_seq  | 0
chunk_data | \x534a36564255574f375246574f4152485a504d59384b4444545a32574750504a374f4c444c3154545859494742364937594245465a47484351585347574c4f4e515a4b44585432384e5032525a38355844334354564d42534f5a38344e534759345444384c3432554e564938593433334b4d46305953553741324f55493157584241575a4258343848413533554a49494c504e4659424e384f55554a3443593434455946325145525a335752475133533957385a4e50455144474c353857345633374a555435463437345731484a59554a36453451514b4f34505331585948494a575455334f38484c365939544c45544451485330585256534c4b55573052563554463631515430344748304b385545463243364f465247563053424d5734453438343338345636593155554d45314549325756385036583254534143375a4254445a4c4e4348434d4a485836333644524a4a4247395a4652364a4a394d434956305431504b5452594a4338543836394d4c355453444d32314554334947454e54453638464a4d4f51365657335232484847573733533158364a323756434953384c50304c5758334b335433363446533443474d5144415a4634345158304f3446385454584c4a585953305a3042574d344934564f53524630444b435135594c4757595848514d574c4f474458533245484949464739473759355933464452395a4c33385846324e43563137484a30594d50534b54344e3050393053353730563958535a34333652305a5031454c3738504e5538434648384e54384f4e4e32585649475848545a504f3344324f524a3359345343524f34474d584e5950334b58533143474d36503746543036355943334a56443632465932345a5a514f31324a37494c365930313236375057524b4a52445756574d535a424e55334c344b4e374d30584b4b4e53484d5853594850564b4a4c5852543447374b4d505530593348475952544e39563138433056353242494d444d48544f5745354b3731354a444243534a5a505058314d514e37503048444b364a475858304a4847394e474c4459505649373731454a4a4c56584437324d4c4b465a554544493030584b34423245313141394f30564f50535534364454314943474b5159474e36595957565737534b4c364250344453355934365549544f35323152354e5841303246575a59565243494e4e3146455232595936434f4e58393651484f58424a35514e50454c5650343743345235393546384f4a38533953425333594a464747484d46454c323651475647354b30364f39435a42573159365831305450334f395257475a4f455955445351485943433849464d45554b494b43435a55463553363248325336544f504d514553534d334d435948474c46464437344b34533850334255464352535347473333524946574449384a54393742324c4531525358535732574e5936564a465130503455414b4b55375a34574c3856385443535439555339454d5a51514850504958373630595a5432345544513932354a5556303637324b3753433537534f384332374638424c453653493349325a47554f324f5659335252463059524c374b3448434630595550563330484d4e4e3534574d3538444a344d5954354d5a3445595746325a463939435a495151373054595a48504355514446595a484559385543314855443154594b344156315857544a495843514c5251445a30324d364548504e55554d4248454649425842364d4456514233563238584a304b4c4b4f4938385057525a3649344c445944354531425154434e493652553431484d5534424a394b56584a4543475253314852474c52354e503058304733365a4f534d4534355358554334544f505255364455564d45544347594a4c54524e554932454a4b44544f5855344f4a455042505138424e47524549465730584b4a364f55435658525352564752534252424c46324a58314e36485338445052394c58555448574e485056494b355253333551453038374c4f4a31534c3359565538445437365551334534514445394a50344642544543464f4d454d314d4d45485047324c494653504948493755304d41505a533437415433334646515732354648483650305a4154504335375835354348494e554e4749545435433552463758355950463931454d455253525032374f505452384f585447575a555332564c544e534b4356373154535831333251383550545738463933573537524d344539313851314b41344b504b3256343647594751474658465837454e5043474f494a3652334f4530414838505355325241585a43334d35444645444a54345944454550355930534e52593632563445314c4b59434e3748324f55595446364f52364d3131385559424b49593045424e53464c4e455743355a4b584c5032535153474d5a354b375557325a53564157464a31344c58544948564a35544c37473850305a3848584d4753333953454345463038373459584b3230334a4853594e314552574a3232453839323031324e374b3156595a5a4c354e4f52583157465149495a4436595256484955304b4a414232443031565a4b415230544d4255544b54504f305150513243344459474b4e48535947574848454a56374432345036424d4d3955444b4a30334b414457455735464957454147564249383750525a54305337425143575a4846514938474f424957574254524d4d504c4d42563353394753514f4b3258504a334b375351493845574833524a484b42
-[ RECORD 2 ]----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
chunk_id   | 16392
chunk_seq  | 1
chunk_data | \x385750354549304232585642474c314a4432375357394b573557463853504f55423735463345593359314951493338514d5a53384a4d4255375137434f3446504847434431474347563158324b375645453647455332574a59334c4a5a454a31454a4e325947474f4f4c4733534a4d503342523746535355424552475732523431414c5255375a304936384858424230594c51425a344143594e393153364734384a524c3958353630325a43504234524753355a57423751434f304a364f475a474d494e354f354c4c49423637444631355a58334a4f45454453444c315956594b3859354b42504e364d535a384f4451385a595742393744444e323957455836364f3051303854584847584c433142313337354f56325936443849383831535555444d54524c4f4a5a314b47515231574d4335433737343854384156323849424b584f424f47533131453746494954505347585252364d3433504b434a46303545465335574231544e433038304f32555756354646595447484b4f534c50315749304247474f415451514b525431584d304e4c4456564e474b57384d343033493530363533554d585a363653594e5157594635484e544c414c35574a53504f305843434b5130454e4c3738334d59583650425a4c36544334574c3656354d354e383849435035533851305755354a3949455835423231525345303954365a32335a485a354a4e3248584a55584a50374d46464657374743383256584e464c3537454e503757484a4c3536495a31505031445753305447594f504531584e504e315843305854373430573041434a373647314d534253454249485a4d334c39443753315958374a4e345742314a59585455424952594d38374e543235454d3435495a5a475a494a50344f515857424d4234574f593054555a3133594c48533732313757493750523949325a4246544d4747354244565744504b4f5953505255514849495244494e565247545a5a55334e5756374b384d48384a5157424833324d524257574459314d324f524b54514630335158384832514443444f524d4c304e344a304254315a4b51313133334559475a324e544433484d434d374d584c464746334c4d55524a3151304233363059434b42474a34333138504f4c4c46505959544439515742564a334e49444d47313257484752354d4f5733344436594759535458484c554d4e354b555048534a514b304b415a50354a464b3335374c3055594a4d3433353538584b4f54384f3946353359494d485042374f554d3735465a3848494144365549495a36444c5931494e484f37505a503830335842544f44313145434a5150444a543636424143453459594d554a32444d325a573642304b32535431473748504a35425550443532514f355256563054474c555034544435335448484e523156333247344c46354a47345437524650445a5748464f55533232594b3559524b58425459594a435654425144453450524e374d38563143564e4d47564d384f5a43484845424832514f374a465853364458374f47464b38454936474b46434c33464b595158445530454f5a464e3257373746425a51584d503455373255453430323736373555394e49484548473836324d5a56335135565036484e4c4953384a334f494e43313448455857593330334a465451484a495a394654454a3237355532573858343259515839524e3231554949525046465052325a4d504f4b304a36433446444a5432564d4653463856514b444a304558445637535144464437483043394a39304b51483257344d47494a384b51484935503130334f5247524f5951364b515631484f4f30474b56354f5a45534f344d514c344f304858524c4c3135494f553255484d4d4242464a324d553042354433384c383745484759304b4852414d56374b4e4247574553564549354a5a3845484c4450304c4456534b5432354c594350505845384c495a4c494a5a4451553747454832564f594947415648524f463350574d57494d54335a324941304f4454324635384c43445648344e584d3841325031335253375035574a3845464530583937484231475652514d513038343839364b37484e3130463038385155424a37334e4f485537394c414b374f5459455858375a354f4942565250495131553852324f55324857514a4d5954413648375551345a5437535433594d394654514a594b594f435745435a4541464d494f32534d31314c5432424956323230334255304f5650384f5a305447534f444b48493547364d4d47424c4e5a4458334353314c323546495547345659584a34464c5952305943524d34593334364132354a423233335a3659584b3738424e37444d4e544c494b50304845384c414b555145323138455848583448554d4438544e44465a5a33534636354c5343464834375934464a37424e3553445654514d585149344e5839324a54394e3438344f5552563854444856464859584448424e554743544532565034534e53464a463856563459424a594d30374d444d37565334433341494352445732534f4734444e4836464450424f494b4244373059544e4a42355754504e5133454352453955474a4d444e3753314c544243534847574b563150444b4e3856354c4a5a373158494f55564b474e4959524730343843475239354d514950534f38534b585937485442474b5a5951574c4158474a4746495645554e545a5357353744543751544730435754385837304f4856444b303843534d3252464b57515a4e4e
-[ RECORD 3 ]----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
chunk_id   | 16392
chunk_seq  | 2
chunk_data | \x54594a3544495a50474652503755474c4b53433533524b5751304634465138454a5859504a303735514d464e33344c4f445433474e344c523548304350394130514e46334435323659315333424d3844433333364b3342324a3034324335464f3833463849315958
```

3 つのチャンクに分割されて登録されました。

Toast テーブルの要約を確認します。

```sql
sample=# SELECT chunk_id, COUNT(*) as chunks, pg_size_pretty(sum(octet_length(chunk_data)::bigint))
FROM pg_toast.pg_toast_16386 GROUP BY 1 ORDER BY 1;
 chunk_id | chunks | pg_size_pretty
----------+--------+----------------
    16392 |      3 | 4096 bytes
(1 row)
```

### Toast 圧縮

```sql
sample=# TRUNCATE toast_test;
TRUNCATE TABLE
sample=# INSERT INTO toast_test (value) VALUES (generate_random_string(1024 * 10));
INSERT 0 1
```

ランダムな文字で構成される 10kb の値を挿入しました

```sql
sample=# SELECT chunk_id, COUNT(*) as chunks, pg_size_pretty(sum(octet_length(chunk_data)::bigint))
FROM pg_toast.pg_toast_16386 GROUP BY 1 ORDER BY 1;
 chunk_id | chunks | pg_size_pretty
----------+--------+----------------
    16397 |      6 | 10 kB
(1 row)
```

toast テーブルのサイズは 10kB なので圧縮の効果は得られていません。
文字のバリエーションを減らすと圧縮効果が得られ、3 分の 1 程度のサイズになります。

```sql
sample=# INSERT INTO toast_test (value) VALUES (generate_random_string(1024 * 10, '123'));
INSERT 0 1

sample=# SELECT chunk_id, COUNT(*) as chunks, pg_size_pretty(sum(octet_length(chunk_data)::bigint))
FROM pg_toast.pg_toast_16386 GROUP BY 1 ORDER BY 1;
 chunk_id | chunks | pg_size_pretty
----------+--------+----------------
    16397 |      6 | 10 kB
    16398 |      2 | 3063 bytes
(2 rows)

```

1 文字で構成された文字列の場合、toast には格納されません

```sql
sample=# insert into toast_test (value) values (generate_random_string(1024 * 10, '0'));
INSERT 0 1
sample=# SELECT chunk_id, COUNT(*) as chunks, pg_size_pretty(sum(octet_length(chunk_data)::bigint))
FROM pg_toast.pg_toast_16386 GROUP BY 1 ORDER BY 1;
 chunk_id | chunks | pg_size_pretty
----------+--------+----------------
    16397 |      6 | 10 kB
    16398 |      2 | 3063 bytes
(2 rows)
```

後片付け

```sql
sample=# drop table toast_test;
DROP TABLE
```

### Toast パフォーマンス

テキストサイズがパフォーマンスに与える影響を確認します

```sql
sample=# CREATE TABLE toast_test_small (id SERIAL, value TEXT);
CREATE TABLE
sample=# CREATE TABLE toast_test_medium (id SERIAL, value TEXT);
CREATE TABLE
sample=# CREATE TABLE toast_test_large (id SERIAL, value TEXT);
CREATE TABLE
```

toast の確認

```sql
sample=# SELECT
    c1.relname,
    c2.relname AS toast_relname
FROM
    pg_class c1
    JOIN pg_class c2 ON c1.reltoastrelid = c2.oid
WHERE
    c1.relname LIKE 'toast_test%'
    AND c1.relkind = 'r';
      relname      | toast_relname
-------------------+----------------
 toast_test_large  | pg_toast_16414
 toast_test_medium | pg_toast_16407
 toast_test_small  | pg_toast_16400
(3 rows)
```

テストデータのセットアップ

```sql
sample=# INSERT INTO toast_test_small (value)
SELECT 'small value' FROM generate_series(1, 500000);
INSERT 0 500000
sample=# WITH str AS (SELECT generate_random_string(1800) AS value)
INSERT INTO toast_test_medium (value)
SELECT value
FROM generate_series(1, 500000), str;
INSERT 0 500000
sample=# WITH str AS (SELECT generate_random_string(4096) AS value)
INSERT INTO toast_test_large (value)
SELECT value
FROM generate_series(1, 500000), str;
INSERT 0 500000
```

パフォーマンスの比較  
2 回ずつ測定

```Sql
sample=# SET max_parallel_workers_per_gather = 0;
SET
sample=# EXPLAIN (ANALYZE, TIMING) SELECT * FROM toast_test_small WHERE id = 6000;
                                                   QUERY PLAN
----------------------------------------------------------------------------------------------------------------
 Seq Scan on toast_test_small  (cost=0.00..8953.00 rows=1 width=16) (actual time=2.682..100.367 rows=1 loops=1)
   Filter: (id = 6000)
   Rows Removed by Filter: 499999
 Planning Time: 0.352 ms
 Execution Time: 100.398 ms
(5 rows)

sample=# EXPLAIN (ANALYZE, TIMING) SELECT * FROM toast_test_small WHERE id = 6000;
                                                  QUERY PLAN
---------------------------------------------------------------------------------------------------------------
 Seq Scan on toast_test_small  (cost=0.00..8953.00 rows=1 width=16) (actual time=0.665..49.770 rows=1 loops=1)
   Filter: (id = 6000)
   Rows Removed by Filter: 499999
 Planning Time: 0.061 ms
 Execution Time: 49.788 ms
(5 rows)
                                                      QUERY PLAN
----------------------------------------------------------------------------------------------------------------------
 Seq Scan on toast_test_medium  (cost=0.00..131250.00 rows=1 width=1808) (actual time=34.346..392.523 rows=1 loops=1)
   Filter: (id = 6000)
   Rows Removed by Filter: 499999
 Planning Time: 0.112 ms
 JIT:
   Functions: 2
   Options: Inlining false, Optimization false, Expressions true, Deforming true
   Timing: Generation 0.668 ms, Inlining 0.000 ms, Optimization 2.030 ms, Emission 27.813 ms, Total 30.512 ms
 Execution Time: 672.100 ms
(9 rows)

sample=# EXPLAIN (ANALYZE, TIMING) SELECT * FROM toast_test_medium WHERE id = 6000;
                                                     QUERY PLAN
---------------------------------------------------------------------------------------------------------------------
 Seq Scan on toast_test_medium  (cost=0.00..131250.00 rows=1 width=1808) (actual time=7.999..365.332 rows=1 loops=1)
   Filter: (id = 6000)
   Rows Removed by Filter: 499999
 Planning Time: 0.112 ms
 JIT:
   Functions: 2
   Options: Inlining false, Optimization false, Expressions true, Deforming true
   Timing: Generation 0.637 ms, Inlining 0.000 ms, Optimization 0.346 ms, Emission 3.135 ms, Total 4.117 ms
 Execution Time: 366.047 ms
(9 rows)
sample=# EXPLAIN (ANALYZE, TIMING) SELECT * FROM toast_test_large WHERE id = 6000;
                                                  QUERY PLAN
---------------------------------------------------------------------------------------------------------------
 Seq Scan on toast_test_large  (cost=0.00..9435.00 rows=1 width=22) (actual time=0.606..47.279 rows=1 loops=1)
   Filter: (id = 6000)
   Rows Removed by Filter: 499999
 Planning Time: 0.102 ms
 Execution Time: 47.294 ms
(5 rows)

sample=# EXPLAIN (ANALYZE, TIMING) SELECT * FROM toast_test_large WHERE id = 6000;
                                                  QUERY PLAN
---------------------------------------------------------------------------------------------------------------
 Seq Scan on toast_test_large  (cost=0.00..9435.00 rows=1 width=22) (actual time=0.609..40.986 rows=1 loops=1)
   Filter: (id = 6000)
   Rows Removed by Filter: 499999
 Planning Time: 0.051 ms
 Execution Time: 41.001 ms
(5 rows)
```

| テーブル          | 速度  |
| ----------------- | ----- |
| toast_test_small  | 49ms  |
| toast_test_medium | 366ms |
| toast_test_large  | 41ms  |

大きなサイズのテーブルが想定より早い理由を確認します

```sql
sample=# SELECT
    c1.relname,
    pg_size_pretty(pg_relation_size(c1.relname::regclass)) AS size,
    c2.relname AS toast_relname,
    pg_size_pretty(pg_relation_size(('pg_toast.' || c2.relname)::regclass)) AS toast_size
FROM
    pg_class c1
    JOIN pg_class c2 ON c1.reltoastrelid = c2.oid
WHERE
    c1.relname LIKE 'toast_test_%'
    AND c1.relkind = 'r';
      relname      |  size  | toast_relname  | toast_size
-------------------+--------+----------------+------------
 toast_test_large  | 25 MB  | pg_toast_16414 | 2604 MB
 toast_test_medium | 977 MB | pg_toast_16407 | 0 bytes
 toast_test_small  | 21 MB  | pg_toast_16400 | 0 bytes
(3 rows)
```

ラージテーブル自体はスモールテーブルと同等に小さく、多くのデータが toast に格納されています。  
クエリプランを見ると、テーブルスキャンが行われているため
中程度のテーブル 977MB をディスクからメモリにロードする必要があり時間が掛かっています。

別のケースとして id 検索ではなく、テキスト検索のパフォーマンスを確認します

```sql
sample=#  \timing
Timing is on.

sample=# SELECT * FROM toast_test_small WHERE value LIKE 'foo%';
 id | value
----+-------
(0 rows)

Time: 56.615 ms
sample=# SELECT * FROM toast_test_small WHERE value LIKE 'foo%';
 id | value
----+-------
(0 rows)

Time: 49.669 ms

sample=# SELECT * FROM toast_test_medium WHERE value LIKE 'foo%';
 id | value
----+-------
(0 rows)

Time: 389.404 ms
sample=# SELECT * FROM toast_test_medium WHERE value LIKE 'foo%';
 id | value
----+-------
(0 rows)

Time: 384.071 ms

sample=# SELECT * FROM toast_test_large WHERE value LIKE 'foo%';
 id | value
----+-------
(0 rows)

Time: 3106.624 ms (00:03.107)
sample=#  SELECT * FROM toast_test_large WHERE value LIKE 'foo%';
 id | value
----+-------
(0 rows)

Time: 3042.457 ms (00:03.042)


```

| テーブル          | 1 回目 | ２回目 |
| ----------------- | ------ | ------ |
| toast_test_small  | 56ms   | 49ms   |
| toast_test_medium | 389ms  | 384ms  |
| toast_test_large  | 3106ms | 3042ms |

テーブルが大きくなるほど、クエリが完了するまでにかかる時間も長くなります。

インデックスについてのパフォーマンスも確認します。

```sql
sample=# CREATE INDEX toast_test_small_id_ix ON toast_test_small(id);
CREATE INDEX
Time: 299.980 ms
sample=# CREATE INDEX toast_test_medium_id_ix ON toast_test_medium(id);
CREATE INDEX
Time: 475.973 ms
sample=# CREATE INDEX toast_test_large_id_ix ON toast_test_large(id);
CREATE INDEX
```

```sql
sample=# EXPLAIN (ANALYZE, TIMING) SELECT * FROM toast_test_small WHERE id = 6000;
                                                                QUERY PLAN
------------------------------------------------------------------------------------------------------------------------------------------
 Index Scan using toast_test_small_id_ix on toast_test_small  (cost=0.42..8.44 rows=1 width=16) (actual time=0.028..0.030 rows=1 loops=1)
   Index Cond: (id = 6000)
 Planning Time: 0.382 ms
 Execution Time: 0.050 ms
(4 rows)
Time: 1.015 ms

sample=#  EXPLAIN (ANALYZE, TIMING) SELECT * FROM toast_test_medium WHERE id = 6000;
                                                                                                                     QUERY PLAN
----------------------------------------------------------------------------------------------------------------------------------------------
 Index Scan using toast_test_medium_id_ix on toast_test_medium  (cost=0.42..8.44 rows=1 width=1808) (actual time=0.050..0.052 rows=1 loops=1)
   Index Cond: (id = 6000)
 Planning Time: 0.455 ms
 Execution Time: 0.080 ms
(4 rows)

Time: 1.263 ms

sample=# EXPLAIN (ANALYZE, TIMING) SELECT * FROM toast_test_large WHERE id = 6000;
                                                                QUERY PLAN
------------------------------------------------------------------------------------------------------------------------------------------
 Index Scan using toast_test_large_id_ix on toast_test_large  (cost=0.42..8.44 rows=1 width=22) (actual time=0.041..0.044 rows=1 loops=1)
   Index Cond: (id = 6000)
 Planning Time: 0.373 ms
 Execution Time: 0.073 ms
(4 rows)
Time: 1.177 ms
```

3 つのケースすべてでインデックスが使用されており、3 つのケースすべてのパフォーマンスがほぼ同じであることがわかります。

次にインデックスを使用しつつ、テーブルの半分をロードするケースを試します

```sql
sample=# EXPLAIN (ANALYZE, TIMING) SELECT * FROM toast_test_small WHERE id BETWEEN 0 AND 250000;
                                                                       QUERY PLAN
--------------------------------------------------------------------------------------------------------------------------------------------------------
 Index Scan using toast_test_small_id_ix on toast_test_small  (cost=0.42..9169.18 rows=251788 width=16) (actual time=0.044..92.252 rows=250000 loops=1)
   Index Cond: ((id >= 0) AND (id <= 250000))
 Planning Time: 0.312 ms
 Execution Time: 109.678 ms
(4 rows)
Time: 110.942 ms

sample=# EXPLAIN (ANALYZE, TIMING) SELECT * FROM toast_test_small WHERE id BETWEEN 0 AND 250000;
                                                                       QUERY PLAN
--------------------------------------------------------------------------------------------------------------------------------------------------------
 Index Scan using toast_test_small_id_ix on toast_test_small  (cost=0.42..9169.18 rows=251788 width=16) (actual time=0.022..53.181 rows=250000 loops=1)
   Index Cond: ((id >= 0) AND (id <= 250000))
 Planning Time: 0.096 ms
 Execution Time: 63.556 ms
(4 rows)
Time: 63.945 ms

sample=# EXPLAIN (ANALYZE, TIMING) SELECT * FROM toast_test_medium WHERE id BETWEEN 0 AND 250000;
                                                                          QUERY PLAN
--------------------------------------------------------------------------------------------------------------------------------------------------------------
 Index Scan using toast_test_medium_id_ix on toast_test_medium  (cost=0.42..70512.88 rows=250923 width=1808) (actual time=0.029..250.228 rows=250000 loops=1)
   Index Cond: ((id >= 0) AND (id <= 250000))
 Planning Time: 0.185 ms
 Execution Time: 261.434 ms
(4 rows)
Time: 261.964 ms
sample=# EXPLAIN (ANALYZE, TIMING) SELECT * FROM toast_test_medium WHERE id BETWEEN 0 AND 250000;

                                                                          QUERY PLAN
--------------------------------------------------------------------------------------------------------------------------------------------------------------
 Index Scan using toast_test_medium_id_ix on toast_test_medium  (cost=0.42..70512.88 rows=250923 width=1808) (actual time=0.026..242.705 rows=250000 loops=1)
   Index Cond: ((id >= 0) AND (id <= 250000))
 Planning Time: 0.528 ms
 Execution Time: 253.491 ms
(4 rows)
Time: 254.487 ms
sample=# EXPLAIN (ANALYZE, TIMING) SELECT * FROM toast_test_large WHERE id BETWEEN 0 AND 250000;

                                                                       QUERY PLAN
--------------------------------------------------------------------------------------------------------------------------------------------------------
 Index Scan using toast_test_large_id_ix on toast_test_large  (cost=0.42..9408.84 rows=251671 width=22) (actual time=0.031..51.178 rows=250000 loops=1)
   Index Cond: ((id >= 0) AND (id <= 250000))
 Planning Time: 0.184 ms
 Execution Time: 60.217 ms
(4 rows)
Time: 60.694 ms

sample=# EXPLAIN (ANALYZE, TIMING) SELECT * FROM toast_test_large WHERE id BETWEEN 0 AND 250000;

                                                                       QUERY PLAN
--------------------------------------------------------------------------------------------------------------------------------------------------------
 Index Scan using toast_test_large_id_ix on toast_test_large  (cost=0.42..9408.84 rows=251671 width=22) (actual time=0.026..45.793 rows=250000 loops=1)
   Index Cond: ((id >= 0) AND (id <= 250000))
 Planning Time: 0.104 ms
 Execution Time: 54.782 ms
(4 rows)
Time: 55.207 ms
```

| テーブル          | 1 回目 | ２回目 |
| ----------------- | ------ | ------ |
| toast_test_small  | 110ms  | 63ms   |
| toast_test_medium | 261ms  | 254ms  |
| toast_test_large  | 60ms   | 54ms   |

データの半分を読み込んだ場合でも中程度のテキストが最も遅い結果になりました

中程度のテキストが遅いのは toast が活用されていないためです。

### 中程度のテキストの対策

toast_tuple_target を調整することでパフォーマンス効果が得られます。

```Sql
sample=# CREATE TABLE toast_test_default_threshold (id SERIAL, value TEXT);
CREATE TABLE
Time: 13.194 ms
sample=# CREATE TABLE toast_test_128_threshold (id SERIAL, value TEXT) WITH (toast_tuple_target=128);
CREATE TABLE
Time: 12.978 ms
sample=# SELECT c1.relname, c2.relname AS toast_relname
FROM pg_class c1 JOIN pg_class c2 ON c1.reltoastrelid = c2.oid
WHERE c1.relname LIKE 'toast%threshold' AND c1.relkind = 'r';
           relname            |  toast_relname
------------------------------+-----------------
 toast_test_128_threshold     | pg_toast_516432
 toast_test_default_threshold | pg_toast_516425
(2 rows)
```

データの登録

```sql
sample=# INSERT INTO toast_test_default_threshold (value) VALUES (generate_random_string(2100, '123'));
INSERT 0 1
Time: 9.120 ms
sample=# INSERT INTO toast_test_128_threshold (value) VALUES (generate_random_string(2100, '123'));
INSERT 0 1
Time: 12.960 ms
sample=# SELECT * FROM pg_toast.pg_toast_516425;
 chunk_id | chunk_seq | chunk_data
----------+-----------+------------
(0 rows)

sample=# \x
Expanded display is on.
sample=# SELECT * FROM pg_toast.pg_toast_516432;
-[ RECORD 1 ]----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
chunk_id   | 516438
chunk_seq  | 0
chunk_data | \x340800004032313331323201043200333133323132333302310503323133323331b831313302030309011733011b68323332070133020f042e3368323131013b31035202053127024b01160471333102733332ef022e0408046d010f31013404730538fe330106026c011802450568024e0216f70203010202c4310270035e01320174fb0106047433024302f402190585034aff01d801b901150263046f010b02ec026aff03b2033e03b901ab140b04cf028a0103ff03ee03c102661321063703b201af1282ff038c02c50229049412591421059d026aff04b1127202200398148411231344123dff050e12cf028c15d91116033703c51239ff13b0052c1319135e124612df22320254ff14691380047b221c051c0208020b110fff120414cd247f13e7236002f3157903dcff12fc13a9144214ec13bf1265055914a3ff122902c402160211228a147f134313a5ff0214249d0239029803d613df14571374ff03e5022113d6036b010f12a9025203d9ff13a6124a249a0235225f02ec03ef03bfff183f159f349c131d23b21434328a03e6ff03e032aa12ce123e03f0149802b0040dff124533c603f805b7023f03f412db0324ff044d050a121b3367237a136403591328ff133d136e1431126902e3031f22ed371aff32971395035212000333249a057d02adff376b067d251233e20512231a041214eeff345c25c722c3042415de06810321035aff239b0554053a1269347f150f534b434bff33cf133e564934b323c233b63560341dff44fb149f465104f2047214ef03ba02beff1859235a024f331b344a54b9233157c1ff136003a2446c04e7028f340504a90521ff02415454436a029445fb05d103653487ff428325895483449d133523c7431c3355ff132413ba03e626893356056f643343c4ff434f431002e21827032f15bd569904fdff13ec2472353115a2442b33de14e454abff446604ca1383648204b0036d053163d3ff0526134d15830447240244a6137d14b3ff1576638912a14523446f43c42309140f7f0310037a6591249153a1540e05a5330031

Time: 0.624 ms
```

または、テキスト別のテーブルに分割する方法もあります。

```sql
CREATE TABLE toast_test_value (fk INT, value TEXT);
CREATE TABLE toast_test (id SERIAL, value_id INT)
```

以上
