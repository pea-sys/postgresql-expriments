# 時系列集計

次のブログのトレースです。

https://www.cybertec-postgresql.com/en/timeseries-exclude-ties-current-row-and-group/

バージョン

```sql
sample=# select version();
                          version
------------------------------------------------------------
 PostgreSQL 16.2, compiled by Visual C++ build 1937, 64-bit
(1 行)
```

DB 作成

```sql
createdb -U postgres sample
psql -U postgres -d sample
```

テーブル作成

```sql
sample=# CREATE TABLE t_demo AS
sample-#        SELECT   ordinality, day, date_part('week', day) AS week
sample-#        FROM    generate_series('2020-01-02', '2020-01-15', '1 day'::interval)
sample-#                        WITH ORDINALITY AS day;
SELECT 14
```

```sql
sample=# select * from t_demo;
 ordinality |          day           | week
------------+------------------------+------
          1 | 2020-01-02 00:00:00+09 |    1
          2 | 2020-01-03 00:00:00+09 |    1
          3 | 2020-01-04 00:00:00+09 |    1
          4 | 2020-01-05 00:00:00+09 |    1
          5 | 2020-01-06 00:00:00+09 |    2
          6 | 2020-01-07 00:00:00+09 |    2
          7 | 2020-01-08 00:00:00+09 |    2
          8 | 2020-01-09 00:00:00+09 |    2
          9 | 2020-01-10 00:00:00+09 |    2
         10 | 2020-01-11 00:00:00+09 |    2
         11 | 2020-01-12 00:00:00+09 |    2
         12 | 2020-01-13 00:00:00+09 |    3
         13 | 2020-01-14 00:00:00+09 |    3
         14 | 2020-01-15 00:00:00+09 |    3
(14 行)
```

### スライディングウィンドウ

```sql
sample=# SELECT *,
sample-#         array_agg(ordinality)
sample-#                 OVER (ORDER BY day ROWS
sample(#                          BETWEEN 1 PRECEDING AND 1 FOLLOWING),
sample-#         avg(ordinality)
sample-#                 OVER (ORDER BY day ROWS
sample(#                          BETWEEN 1 PRECEDING AND 1 FOLLOWING)
sample-# FROM t_demo;
 ordinality |          day           | week | array_agg  |         avg
------------+------------------------+------+------------+---------------------
          1 | 2020-01-02 00:00:00+09 |    1 | {1,2}      |  1.5000000000000000
          2 | 2020-01-03 00:00:00+09 |    1 | {1,2,3}    |  2.0000000000000000
          3 | 2020-01-04 00:00:00+09 |    1 | {2,3,4}    |  3.0000000000000000
          4 | 2020-01-05 00:00:00+09 |    1 | {3,4,5}    |  4.0000000000000000
          5 | 2020-01-06 00:00:00+09 |    2 | {4,5,6}    |  5.0000000000000000
          6 | 2020-01-07 00:00:00+09 |    2 | {5,6,7}    |  6.0000000000000000
          7 | 2020-01-08 00:00:00+09 |    2 | {6,7,8}    |  7.0000000000000000
          8 | 2020-01-09 00:00:00+09 |    2 | {7,8,9}    |  8.0000000000000000
          9 | 2020-01-10 00:00:00+09 |    2 | {8,9,10}   |  9.0000000000000000
         10 | 2020-01-11 00:00:00+09 |    2 | {9,10,11}  | 10.0000000000000000
         11 | 2020-01-12 00:00:00+09 |    2 | {10,11,12} | 11.0000000000000000
         12 | 2020-01-13 00:00:00+09 |    3 | {11,12,13} | 12.0000000000000000
         13 | 2020-01-14 00:00:00+09 |    3 | {12,13,14} | 13.0000000000000000
         14 | 2020-01-15 00:00:00+09 |    3 | {13,14}    | 13.5000000000000000
(14 行)
```

# 現在の行を除外した集計

```sql
sample=# SELECT *, array_agg(ordinality)
sample-#                OVER (ORDER BY day ROWS
sample(#                        BETWEEN 1 PRECEDING AND 1 FOLLOWING
sample(#                        EXCLUDE CURRENT ROW)
sample-#        FROM  t_demo;
 ordinality |          day           | week | array_agg
------------+------------------------+------+-----------
          1 | 2020-01-02 00:00:00+09 |    1 | {2}
          2 | 2020-01-03 00:00:00+09 |    1 | {1,3}
          3 | 2020-01-04 00:00:00+09 |    1 | {2,4}
          4 | 2020-01-05 00:00:00+09 |    1 | {3,5}
          5 | 2020-01-06 00:00:00+09 |    2 | {4,6}
          6 | 2020-01-07 00:00:00+09 |    2 | {5,7}
          7 | 2020-01-08 00:00:00+09 |    2 | {6,8}
          8 | 2020-01-09 00:00:00+09 |    2 | {7,9}
          9 | 2020-01-10 00:00:00+09 |    2 | {8,10}
         10 | 2020-01-11 00:00:00+09 |    2 | {9,11}
         11 | 2020-01-12 00:00:00+09 |    2 | {10,12}
         12 | 2020-01-13 00:00:00+09 |    3 | {11,13}
         13 | 2020-01-14 00:00:00+09 |    3 | {12,14}
         14 | 2020-01-15 00:00:00+09 |    3 | {13}
(14 行)
```

# 同位を除外した集計

```sql
sample=# SELECT   day, week,
sample-#         array_agg(week) OVER (ORDER BY week ROWS
sample(#                 BETWEEN 2 PRECEDING AND 2 FOLLOWING) AS all,
sample-#         array_agg(week) OVER (ORDER BY week ROWS
sample(#                 BETWEEN 2 PRECEDING AND 2 FOLLOWING EXCLUDE TIES) AS ties
sample-# FROM    t_demo;
          day           | week |     all     |  ties
------------------------+------+-------------+---------
 2020-01-02 00:00:00+09 |    1 | {1,1,1}     | {1}
 2020-01-03 00:00:00+09 |    1 | {1,1,1,1}   | {1}
 2020-01-04 00:00:00+09 |    1 | {1,1,1,1,2} | {1,2}
 2020-01-05 00:00:00+09 |    1 | {1,1,1,2,2} | {1,2,2}
 2020-01-06 00:00:00+09 |    2 | {1,1,2,2,2} | {1,1,2}
 2020-01-07 00:00:00+09 |    2 | {1,2,2,2,2} | {1,2}
 2020-01-08 00:00:00+09 |    2 | {2,2,2,2,2} | {2}
 2020-01-09 00:00:00+09 |    2 | {2,2,2,2,2} | {2}
 2020-01-10 00:00:00+09 |    2 | {2,2,2,2,2} | {2}
 2020-01-11 00:00:00+09 |    2 | {2,2,2,2,3} | {2,3}
 2020-01-12 00:00:00+09 |    2 | {2,2,2,3,3} | {2,3,3}
 2020-01-13 00:00:00+09 |    3 | {2,2,3,3,3} | {2,2,3}
 2020-01-14 00:00:00+09 |    3 | {2,3,3,3}   | {2,3}
 2020-01-15 00:00:00+09 |    3 | {3,3,3}     | {3}
(14 行)

```

### グループ全体を除外した集計

```Sql
sample=# SELECT   *,
sample-#         array_agg(week) OVER (ORDER BY week ROWS
sample(#                                 BETWEEN 2 PRECEDING
sample(#                        AND 2 FOLLOWING EXCLUDE GROUP) AS week,
sample-#         array_agg(week) OVER (ORDER BY day ROWS
sample(#                                 BETWEEN 2 PRECEDING
sample(#                        AND 2 FOLLOWING EXCLUDE GROUP) AS all
sample-# FROM    t_demo;
 ordinality |          day           | week | week  |    all
------------+------------------------+------+-------+-----------
          1 | 2020-01-02 00:00:00+09 |    1 |       | {1,1}
          2 | 2020-01-03 00:00:00+09 |    1 |       | {1,1,1}
          3 | 2020-01-04 00:00:00+09 |    1 | {2}   | {1,1,1,2}
          4 | 2020-01-05 00:00:00+09 |    1 | {2,2} | {1,1,2,2}
          5 | 2020-01-06 00:00:00+09 |    2 | {1,1} | {1,1,2,2}
          6 | 2020-01-07 00:00:00+09 |    2 | {1}   | {1,2,2,2}
          7 | 2020-01-08 00:00:00+09 |    2 |       | {2,2,2,2}
          8 | 2020-01-09 00:00:00+09 |    2 |       | {2,2,2,2}
          9 | 2020-01-10 00:00:00+09 |    2 |       | {2,2,2,2}
         10 | 2020-01-11 00:00:00+09 |    2 | {3}   | {2,2,2,3}
         11 | 2020-01-12 00:00:00+09 |    2 | {3,3} | {2,2,3,3}
         12 | 2020-01-13 00:00:00+09 |    3 | {2,2} | {2,2,3,3}
         13 | 2020-01-14 00:00:00+09 |    3 | {2}   | {2,3,3}
         14 | 2020-01-15 00:00:00+09 |    3 |       | {3,3}
(14 行)
```
