# 配列型や JSON 型によるデータサイズ削減

次のブログ記事の内容をトレースします  
ここに書いてあることはデータモデルがストレージに与える影響についてです。

https://www.crunchydata.com/blog/how-your-postgresql-data-model-affects-storage

個人的に惹かれたのは、配列を使用することによるストレージ格納効率の向上です。  
配列は取り扱いにくいもので、カラムの明瞭度も落ち、UPDATE 時のパフォーマンスの低下などありますが、アーカイブデータであれば、積極的に使っていって良いかもと感じました。

データベース作成

```
masami@masami-L ~/Desktop> sudo -i -u postgres
postgres@masami-L ~> createdb -U postgres sample
```

## 配列なしの基本的なデータモデル

テーブル作成

```sql
sample=# CREATE TABLE parent (
    id bigserial PRIMARY KEY,
    pname text NOT NULL, pts timestamptz NOT NULL
);
CREATE UNIQUE INDEX parent_pname ON parent(pname, pts);
CREATE INDEX parent_pts ON parent(pts);

CREATE TABLE detail (
    pid int8 NOT NULL REFERENCES parent(id),
    elemname text NOT NULL,
    elemval float8 NOT NULL,
    PRIMARY KEY (pid, elemname)
);
CREATE INDEX detail_elemname ON detail(elemname);
CREATE TABLE
CREATE INDEX
CREATE INDEX
CREATE TABLE
CREATE INDEX
```

データ登録  
親テーブルに 100,000 行、詳細テーブルに 1,000 万行を作成

```sql
sample=# INSERT INTO parent (pname, pts)
SELECT
    'pname ' || (g.i % 14197)::text,
    now() + (g.i::text || ' seconds')::interval
FROM generate_series(1,100000) AS g(i);

INSERT INTO detail
SELECT p.id,
    'elem_' || (
        CASE WHEN g.i < 10 THEN '0' || g.i::text
        ELSE g.i::text
        END
    ),
    (g.i % 10) + random()
FROM parent AS p, generate_series(0,99) AS g(i);

VACUUM FREEZE ANALYZE;
INSERT 0 100000
INSERT 0 10000000
VACUUM
sample=# select count(*) from parent;
 count
--------
 100000
(1 row)

sample=# select count(*) from detail;
  count
----------
 10000000
(1 row)
sample=# select * from parent limit 3;
 id |  pname  |              pts
----+---------+-------------------------------
  1 | pname 1 | 2024-02-20 22:12:56.364079+09
  2 | pname 2 | 2024-02-20 22:12:57.364079+09
  3 | pname 3 | 2024-02-20 22:12:58.364079+09
(3 rows)
sample=# select * from detail limit 3;
 pid | elemname |       elemval
-----+----------+---------------------
   1 | elem_00  |  0.8073799597017413
   2 | elem_00  | 0.39073776262991444
   3 | elem_00  |  0.4568458953944372
(3 rows)

```

2 つのテーブルの合計サイズ

```sql
sample=# SELECT pg_size_pretty(pg_total_relation_size('parent'::regclass) +
    pg_total_relation_size('detail'::regclass));
 pg_size_pretty
----------------
 959 MB
(1 row)
```

測定してみます

```sql
CREATE OR REPLACE FUNCTION timeit(insql text)
RETURNS interval
AS $$
DECLARE
    tgtpid bigint;
    startts timestamp;
    sumint interval = '0 seconds';
    rec record;
    i int; numiters int := 1000;
BEGIN
    FOR i IN 1..numiters LOOP
        tgtpid := round(100000 * random());
        startts := clock_timestamp();
        EXECUTE insql INTO rec using tgtpid;
        sumint := sumint + (clock_timestamp() - startts)::interval;
    END LOOP;
    RETURN (sumint / numiters);
END;
$$ LANGUAGE plpgsql;

SELECT timeit(
$$
    SELECT count(1) FROM parent p JOIN detail d ON d.pid = p.id WHERE p.id = $1
$$);
```

## 配列を使用したデータモデル

テーブル作成

```sql

CREATE TABLE parentdetail (
    id int8 PRIMARY KEY,
    pname text NOT NULL,
    pts timestamptz NOT NULL,
    elemnames text[],
    elemvals float8[]
);
CREATE UNIQUE INDEX parentdetail_pname ON parentdetail(pname, pts);
CREATE INDEX parentdetail_pts ON parentdetail(pts);
CREATE INDEX parentdetail_elemnames ON parentdetail USING GIN(elemnames);

CREATE TABLE
CREATE INDEX
CREATE INDEX
CREATE INDEX
```

配列を使用しないテーブルからデータをコピー

```sql
INSERT INTO parentdetail
SELECT id, pname, pts, array_agg(elemname), array_agg(elemval)
FROM (
    SELECT p.id, p.pname, p.pts, d.elemname, d.elemval
    FROM parent p
    JOIN detail d ON d.pid = p.id
    ORDER BY p.id, p.pts, d.elemname
) AS ss
GROUP BY id, pname, pts;
INSERT 0 100000

sample=# VACUUM FREEZE ANALYZE parentdetail;
VACUUM

sample=# select count(*) from parentdetail;
 count
--------
 100000
(1 row)

```

各配列カラムには１００要素が格納されています

```sql
sample=# \x
Expanded display is on.
sample=# select * from parentdetail limit 3;
-[ RECORD 1 ]-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
id        | 1
pname     | pname 1
pts       | 2024-02-20 22:34:59.266191+09
elemnames | {elem_00,elem_01,elem_02,elem_03,elem_04,elem_05,elem_06,elem_07,elem_08,elem_09,elem_10,elem_11,elem_12,elem_13,elem_14,elem_15,elem_16,elem_17,elem_18,elem_19,elem_20,elem_21,elem_22,elem_23,elem_24,elem_25,elem_26,elem_27,elem_28,elem_29,elem_30,elem_31,elem_32,elem_33,elem_34,elem_35,elem_36,elem_37,elem_38,elem_39,elem_40,elem_41,elem_42,elem_43,elem_44,elem_45,elem_46,elem_47,elem_48,elem_49,elem_50,elem_51,elem_52,elem_53,elem_54,elem_55,elem_56,elem_57,elem_58,elem_59,elem_60,elem_61,elem_62,elem_63,elem_64,elem_65,elem_66,elem_67,elem_68,elem_69,elem_70,elem_71,elem_72,elem_73,elem_74,elem_75,elem_76,elem_77,elem_78,elem_79,elem_80,elem_81,elem_82,elem_83,elem_84,elem_85,elem_86,elem_87,elem_88,elem_89,elem_90,elem_91,elem_92,elem_93,elem_94,elem_95,elem_96,elem_97,elem_98,elem_99}
elemvals  | {0.5578424781174114,1.8688987233777858,2.532454784695549,3.551012583798954,4.781002846813838,5.692092965591744,6.052276109038051,7.038741584440093,8.274526448795289,9.290948370139265,0.9158197388739815,1.087443029095855,2.594387409923886,3.2410466068277834,4.938978012956088,5.2240230504643,6.6992087818430015,7.903430771245983,8.105917195818368,9.526474207024737,0.48151254197725635,1.9558553847637974,2.100327477776066,3.1551254830377253,4.298969593532522,5.924036394532411,6.83667297492568,7.8838922885450735,8.505649765495921,9.712901173484259,0.991441729144956,1.6315264593698409,2.9832718126358237,3.1378385203330232,4.534395708092891,5.9928662571163365,6.6724534155018524,7.4559486595736395,8.259820805209731,9.77008636917012,0.10396118042487856,1.8972932414822914,2.3177768397169736,3.5039479086979988,4.929960639517024,5.196145342116413,6.745347556617364,7.005048414648034,8.45526625067166,9.122239463314688,0.9978906266949004,1.885071851749533,2.1685913975634072,3.0120215326970516,4.480287646514828,5.088038610513056,6.273798389648139,7.299898903664687,8.078194138423644,9.421555507230412,0.2211484621629758,1.049490355400028,2.689289550549095,3.0880657839746597,4.23855177612629,5.4848760928667595,6.754527256800177,7.216099108600108,8.862817418337702,9.521847746809815,0.7893845568671374,1.3915215747423169,2.4709034013780844,3.299158373755379,4.915112676221472,5.1887857018180945,6.8111666636095585,7.709772456010885,8.389986766115928,9.7021804350255,0.5346130691754958,1.9321159016650178,2.1405559035845023,3.0770811453438434,4.726147408000518,5.961326044587711,6.292893091442441,7.041199629533683,8.435823395790496,9.140501644430149,0.7038452582862398,1.4358341101368275,2.210093674032553,3.6919528866247653,4.4922832584936465,5.747119235476337,6.623059809995059,7.248451382385245,8.570351872223657,9.63727607965652}
-[ RECORD 2 ]-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
id        | 2
pname     | pname 2
pts       | 2024-02-20 22:35:00.266191+09
elemnames | {elem_00,elem_01,elem_02,elem_03,elem_04,elem_05,elem_06,elem_07,elem_08,elem_09,elem_10,elem_11,elem_12,elem_13,elem_14,elem_15,elem_16,elem_17,elem_18,elem_19,elem_20,elem_21,elem_22,elem_23,elem_24,elem_25,elem_26,elem_27,elem_28,elem_29,elem_30,elem_31,elem_32,elem_33,elem_34,elem_35,elem_36,elem_37,elem_38,elem_39,elem_40,elem_41,elem_42,elem_43,elem_44,elem_45,elem_46,elem_47,elem_48,elem_49,elem_50,elem_51,elem_52,elem_53,elem_54,elem_55,elem_56,elem_57,elem_58,elem_59,elem_60,elem_61,elem_62,elem_63,elem_64,elem_65,elem_66,elem_67,elem_68,elem_69,elem_70,elem_71,elem_72,elem_73,elem_74,elem_75,elem_76,elem_77,elem_78,elem_79,elem_80,elem_81,elem_82,elem_83,elem_84,elem_85,elem_86,elem_87,elem_88,elem_89,elem_90,elem_91,elem_92,elem_93,elem_94,elem_95,elem_96,elem_97,elem_98,elem_99}
elemvals  | {0.5517032157172821,1.5748317008439585,2.2451892766674177,3.548539114875382,4.314386996179621,5.027413195081579,6.549060614637995,7.249279171226533,8.048426429311405,9.869324486208995,0.9994731068534861,1.863419108562482,2.705281995802636,3.681435844955274,4.86334743908202,5.650570652690419,6.093897086499567,7.62866295220573,8.718212207247973,9.907515939573784,0.7869480024046993,1.3662168990019268,2.358453917431973,3.874457515332267,4.027093954676786,5.9458541865416805,6.7015669858708975,7.641268336241808,8.63322706463083,9.722126726179056,0.6944037389578739,1.0537417687345965,2.9067223637380835,3.2586318394243676,4.21942441324228,5.619841589399073,6.5376877936260485,7.234262257944181,8.000947155429742,9.415951984979927,0.5112142060784777,1.3494561235613105,2.5113980223821386,3.9931275523780982,4.0136253630353735,5.2324469882548215,6.877560981117597,7.283343298650777,8.338727936592988,9.345513814160029,0.7868279088104941,1.505744641011404,2.794061509003825,3.891230973568497,4.393448592791458,5.072897406829668,6.6071485726766355,7.718718248928042,8.224780730547366,9.49703783363151,0.8317445301764224,1.2298908328427274,2.087539929721345,3.296322569099118,4.254087694224438,5.285709328072869,6.974049708112773,7.901078671070934,8.299149287698185,9.112429747535032,0.968491493677277,1.5600536075416471,2.936883443631416,3.2078535143020304,4.153154624526735,5.246665256662197,6.588477205214133,7.24757746160293,8.514686348929274,9.565251906739775,0.03260052579258854,1.991243832823045,2.850341825309272,3.657322256237819,4.311656268869285,5.188790281503941,6.674234122247356,7.1078054137760205,8.638030208102975,9.486699871343433,0.1235842184804028,1.8513008981303187,2.3003410273086615,3.334251076195585,4.864971002901541,5.078328638232904,6.569690320457596,7.889767780070713,8.000581274560147,9.141578973172216}
-[ RECORD 3 ]-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
id        | 3
pname     | pname 3
pts       | 2024-02-20 22:35:01.266191+09
elemnames | {elem_00,elem_01,elem_02,elem_03,elem_04,elem_05,elem_06,elem_07,elem_08,elem_09,elem_10,elem_11,elem_12,elem_13,elem_14,elem_15,elem_16,elem_17,elem_18,elem_19,elem_20,elem_21,elem_22,elem_23,elem_24,elem_25,elem_26,elem_27,elem_28,elem_29,elem_30,elem_31,elem_32,elem_33,elem_34,elem_35,elem_36,elem_37,elem_38,elem_39,elem_40,elem_41,elem_42,elem_43,elem_44,elem_45,elem_46,elem_47,elem_48,elem_49,elem_50,elem_51,elem_52,elem_53,elem_54,elem_55,elem_56,elem_57,elem_58,elem_59,elem_60,elem_61,elem_62,elem_63,elem_64,elem_65,elem_66,elem_67,elem_68,elem_69,elem_70,elem_71,elem_72,elem_73,elem_74,elem_75,elem_76,elem_77,elem_78,elem_79,elem_80,elem_81,elem_82,elem_83,elem_84,elem_85,elem_86,elem_87,elem_88,elem_89,elem_90,elem_91,elem_92,elem_93,elem_94,elem_95,elem_96,elem_97,elem_98,elem_99}
elemvals  | {0.011192177232583589,1.2261017701753012,2.6476683728557013,3.2989821410690006,4.423396950169131,5.039980834521867,6.705997676957946,7.986420148226198,8.13047389644667,9.455212986563748,0.936126589799283,1.5047769231057195,2.553468438619216,3.1469482631127725,4.441137887449354,5.808896106035018,6.172813206272036,7.04503640801202,8.77412655300905,9.498946044372797,0.30957803602164446,1.1152768721358193,2.7194497766105137,3.6016697925090106,4.906719971515809,5.140668813389748,6.073976955417134,7.351635111864862,8.310333263433545,9.502661096710636,0.4283396936235526,1.9724844708928053,2.050899369485119,3.9624022940665604,4.948181802455661,5.458185045076544,6.624536954412047,7.441990684456851,8.1554093001706,9.35427871693103,0.27425188998709515,1.8057242539120857,2.709440412056761,3.5391320760024705,4.771187255014279,5.6413506954940935,6.188455570433785,7.005186418868316,8.195873335328866,9.041317409295953,0.8706474146525629,1.6402077491372715,2.7194776237973706,3.3840215024419926,4.515470791095236,5.00853677744929,6.38505482031756,7.115059789087791,8.144892753175196,9.132338921475576,0.8887968318184498,1.528478790420177,2.8246425613370825,3.2728543059185817,4.3612827722603065,5.548024734657229,6.445461683056788,7.711647762512012,8.148728962634646,9.508393557048276,0.504353792841453,1.5318588300208198,2.5942389309642344,3.936480899873896,4.885834772229469,5.399451754241209,6.819053412303088,7.332632112445918,8.643182709790477,9.344465488000633,0.5038003487364726,1.9518922511074202,2.7796879011253672,3.542263691157796,4.669744889380905,5.585256079232732,6.029902848866282,7.094784730602651,8.46003939038415,9.340918067227431,0.640892262676612,1.8117916802564018,2.920973414925225,3.4255223925283467,4.153483059250998,5.992122321071502,6.783223733214395,7.925412939603557,8.183514362315332,9.204939141031655}

postgres=# select array_length(elemnames, 1) from parentdetail limit 1;
 array_length
--------------
          100
(1 row)
```

テーブルサイズを測定します

```sql
sample=# SELECT pg_size_pretty(pg_table_size('parentdetail'::regclass));
 pg_size_pretty
----------------
 130 MB
(1 row)

sample=# SELECT pg_size_pretty(pg_indexes_size('parentdetail'::regclass));
 pg_size_pretty
----------------
 28 MB
(1 row)

sample=# SELECT pg_size_pretty(pg_total_relation_size('parentdetail_pkey'));
 pg_size_pretty
----------------
 2208 kB
(1 row)

sample=# SELECT pg_size_pretty(pg_total_relation_size('parentdetail_pname'));
 pg_size_pretty
----------------
 4136 kB
(1 row)

sample=# SELECT pg_size_pretty(pg_total_relation_size('parentdetail_pts'));
 pg_size_pretty
----------------
 2208 kB
(1 row)

sample=# SELECT pg_size_pretty(pg_total_relation_size('parentdetail_elemnames'));
 pg_size_pretty
----------------
 20 MB
(1 row)

sample=# SELECT pg_size_pretty(pg_total_relation_size('parentdetail'::regclass));
 pg_size_pretty
----------------
 159 MB
(1 row)

sample=# SELECT timeit( $$ SELECT count(1) FROM parentdetail WHERE id = $1 $$);
     timeit
-----------------
 00:00:00.000106
(1 row)
```

元のテーブルから 8 割以上のサイズ削減が出来ました。

テーブルのストレージが extended の項目はトーストにより圧縮されています。

```sql
sample-# \d+  parentdetail
                                           テーブル"public.parentdetail"
    列     |          タイプ          | 照合順序 | Null 値を許容 | デフォルト | ストレージ | 圧縮 | 統計目標 | 説明
-----------+--------------------------+----------+---------------+------------+------------+------+----------+------
 id        | bigint                   |          | not null      |            | plain      |      |          |
 pname     | text                     |          | not null      |            | extended   |      |          |
 pts       | timestamp with time zone |          | not null      |            | plain      |      |          |
 elemnames | text[]                   |          |               |            | extended   |      |          |
 elemvals  | double precision[]       |          |               |            | extended   |      |          |
インデックス:
    "parentdetail_pkey" PRIMARY KEY, btree (id)
    "parentdetail_elemnames" gin (elemnames)
    "parentdetail_pname" UNIQUE, btree (pname, pts)
    "parentdetail_pts" btree (pts)
アクセスメソッド: heap
```

トーストは PostgreSQL の内部メカニズムであり、デフォルトで 2040 バイトのしきい値を超える行のデータを圧縮しようとします。これを 1024 にすることで更にデータ圧縮できます。

```sql
sample=# DROP TABLE parentdetail;

CREATE TABLE parentdetail  (
   id int8 NOT NULL,
   pname text NOT NULL,
   pts timestamptz NOT NULL,
   elemnames text[],
   elemvals float8[]
)
WITH (toast_tuple_target = 1024);

INSERT INTO parentdetail
SELECT id, pname, pts, array_agg(elemname), array_agg(elemval)
FROM (
   SELECT p.id, p.pname, p.pts, d.elemname, d.elemval
   FROM parent p
   JOIN detail d ON d.pid = p.id
   ORDER BY p.id, p.pts, d.elemname
) AS ss
GROUP BY id, pname, pts;

ALTER TABLE parentdetail ADD PRIMARY KEY(id);

CREATE UNIQUE INDEX parentdetail_pname ON parentdetail(pname, pts);
CREATE INDEX parentdetail_pts ON parentdetail(pts);
CREATE INDEX parentdetail_elemnames ON parentdetail USING GIN(elemnames);

VACUUM FREEZE ANALYZE parentdetail;

SELECT pg_size_pretty(pg_table_size('parentdetail'));
DROP TABLE
CREATE TABLE
INSERT 0 100000
ALTER TABLE
CREATE INDEX
CREATE INDEX
CREATE INDEX
VACUUM
pg_size_pretty
----------------
132 MB
(1 row)

sample=# SELECT pg_size_pretty(pg_indexes_size('parentdetail'));
pg_size_pretty
----------------
20 MB
(1 row)

sample=# SELECT pg_size_pretty(pg_total_relation_size('parentdetail_pkey'));
pg_size_pretty
----------------
2208 kB
(1 row)

sample=# SELECT pg_size_pretty(pg_total_relation_size('parentdetail_pname'));
pg_size_pretty
----------------
3992 kB
(1 row)

sample=# SELECT pg_size_pretty(pg_total_relation_size('parentdetail_pts'));
pg_size_pretty
----------------
2208 kB
(1 row)

sample=# SELECT pg_size_pretty(pg_total_relation_size('parentdetail_elemnames'));
pg_size_pretty
----------------
12 MB
(1 row)

sample=# SELECT pg_size_pretty(pg_total_relation_size('parentdetail'::regclass));
pg_size_pretty
----------------
152 MB
(1 row)

sample=# SELECT timeit(
$$
 SELECT count(1) FROM parentdetail WHERE id = $1
$$
);
    timeit
----------------
00:00:00.00008
(1 row)
```

159MB から 152MB に削減できました

elemnames に対して作成されたインデックスは、多くのユースケースではあまり役に立たないので削除します

```sql
postgres=# DROP INDEX parentdetail_elemnames;

SELECT pg_size_pretty(pg_total_relation_size('parentdetail'::regclass));
DROP INDEX
 pg_size_pretty
----------------
 139 MB
(1 row)

postgres=# SELECT timeit($$
    SELECT count(1) FROM parentdetail WHERE id = $1
$$);
     timeit
-----------------
 00:00:00.000098
(1 row)
```

152MB から 139MB に削減できました

### 洗練されたデータモデル

elemnames は有用な情報ではないので削除します

```Sql
postgres=# select elemnames from parentdetail limit 2;
-[ RECORD 1 ]--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
elemnames | {elem_00,elem_01,elem_02,elem_03,elem_04,elem_05,elem_06,elem_07,elem_08,elem_09,elem_10,elem_11,elem_12,elem_13,elem_14,elem_15,elem_16,elem_17,elem_18,elem_19,elem_20,elem_21,elem_22,elem_23,elem_24,elem_25,elem_26,elem_27,elem_28,elem_29,elem_30,elem_31,elem_32,elem_33,elem_34,elem_35,elem_36,elem_37,elem_38,elem_39,elem_40,elem_41,elem_42,elem_43,elem_44,elem_45,elem_46,elem_47,elem_48,elem_49,elem_50,elem_51,elem_52,elem_53,elem_54,elem_55,elem_56,elem_57,elem_58,elem_59,elem_60,elem_61,elem_62,elem_63,elem_64,elem_65,elem_66,elem_67,elem_68,elem_69,elem_70,elem_71,elem_72,elem_73,elem_74,elem_75,elem_76,elem_77,elem_78,elem_79,elem_80,elem_81,elem_82,elem_83,elem_84,elem_85,elem_86,elem_87,elem_88,elem_89,elem_90,elem_91,elem_92,elem_93,elem_94,elem_95,elem_96,elem_97,elem_98,elem_99}
-[ RECORD 2 ]--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
elemnames | {elem_00,elem_01,elem_02,elem_03,elem_04,elem_05,elem_06,elem_07,elem_08,elem_09,elem_10,elem_11,elem_12,elem_13,elem_14,elem_15,elem_16,elem_17,elem_18,elem_19,elem_20,elem_21,elem_22,elem_23,elem_24,elem_25,elem_26,elem_27,elem_28,elem_29,elem_30,elem_31,elem_32,elem_33,elem_34,elem_35,elem_36,elem_37,elem_38,elem_39,elem_40,elem_41,elem_42,elem_43,elem_44,elem_45,elem_46,elem_47,elem_48,elem_49,elem_50,elem_51,elem_52,elem_53,elem_54,elem_55,elem_56,elem_57,elem_58,elem_59,elem_60,elem_61,elem_62,elem_63,elem_64,elem_65,elem_66,elem_67,elem_68,elem_69,elem_70,elem_71,elem_72,elem_73,elem_74,elem_75,elem_76,elem_77,elem_78,elem_79,elem_80,elem_81,elem_82,elem_83,elem_84,elem_85,elem_86,elem_87,elem_88,elem_89,elem_90,elem_91,elem_92,elem_93,elem_94,elem_95,elem_96,elem_97,elem_98,elem_99}
```

```sql
postgres=# CREATE TABLE parentdetail2 (
    id int8 NOT NULL,
    pname text NOT NULL,
    pts timestamptz NOT NULL,
    elemvals float8[]
);

INSERT INTO parentdetail2
SELECT id, pname, pts, elemvals
FROM parentdetail;

ALTER TABLE parentdetail2 ADD PRIMARY KEY(id);
CREATE UNIQUE INDEX parentdetail2_pname ON parentdetail2(pname, pts);
CREATE INDEX parentdetail2_pts ON parentdetail2(pts);

VACUUM FREEZE ANALYZE parentdetail2;

SELECT pg_size_pretty(pg_total_relation_size('parentdetail2'::regclass));
CREATE TABLE
INSERT 0 100000
ALTER TABLE
CREATE INDEX
CREATE INDEX
VACUUM
 pg_size_pretty
----------------
 95 MB
(1 row)
postgres=# SELECT timeit(
$$
    SELECT count(1) FROM parentdetail2 WHERE id = $1
$$);
     timeit
-----------------
 00:00:00.000059
(1 row)

postgres=# select count(*) from parentdetail2;
 count
--------
 100000
(1 row)

postgres=# select * from parentdetail2 limit 3;
-[ RECORD 1 ]-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
id       | 1
pname    | pname 1
pts      | 2024-02-21 06:44:07.078976+09
elemvals | {0.6068951632642801,1.1272389787493147,2.657751134597074,3.181628010424415,4.411481164147144,5.893127615183143,6.753911377655495,7.595556243595606,8.031549816146335,9.369058792765113,0.9353754984270743,1.5488956688281768,2.6346274835883285,3.4842318494545133,4.160593933503915,5.5469259463470415,6.040401175330853,7.390319267741884,8.180802764009368,9.458024880908365,0.001968544762885216,1.7427166746490137,2.8212737155980356,3.7949184217995615,4.487087889804652,5.981792841728943,6.2625641584557705,7.995930662839296,8.95942815290763,9.614139685065961,0.3217671072996744,1.7062338423774825,2.6598189210545478,3.4938222652756075,4.733761221378099,5.059098343295286,6.887500425759381,7.103628787504672,8.432460804470647,9.957142693005121,0.28137354306735674,1.8363206014311935,2.8320658048881704,3.353583563450652,4.101249793554953,5.275882201264462,6.108311815472771,7.533485771106793,8.509101342329895,9.478771225745017,0.4797200735978002,1.3950122769797098,2.850310999031162,3.2551684581446487,4.488847461167861,5.730674186606816,6.93492221782898,7.450227826266396,8.283536504618805,9.508580750056776,0.31888909742482596,1.2253264024445478,2.8981653749177347,3.153689361929505,4.585326381051427,5.339314403544645,6.534897887563002,7.829055561356167,8.62575945647276,9.429765190963476,0.8449335025842082,1.7170830319991772,2.921374355984053,3.294225270629081,4.209757324542206,5.3007736020522,6.824267756411782,7.171464293000749,8.022390102529098,9.644977244240149,0.8386969791136742,1.0227250530690206,2.968638230168235,3.6776420758191897,4.902329989978707,5.8129734903556844,6.30834374561422,7.4710643585767365,8.667495399427107,9.79214868891378,0.15663433155290463,1.5231384988314538,2.782432462410352,3.776412877327598,4.765173315201391,5.038607047433256,6.172541078411168,7.429401428712676,8.803409668308031,9.210310699763308}
-[ RECORD 2 ]-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
id       | 2
pname    | pname 2
pts      | 2024-02-21 06:44:08.078976+09
elemvals | {0.40084972922144146,1.6611741945220828,2.1629586327608976,3.4874988564403893,4.625543354836132,5.462309163137398,6.516403981587779,7.432654544625812,8.72884124002561,9.296338978037475,0.15466431052853835,1.9599288001233717,2.7671986393446204,3.546760519753626,4.9542937510910505,5.854948630417503,6.1013310612541645,7.06539342272341,8.424231688689439,9.699788796898893,0.052464268121489965,1.82863007529064,2.362052762644076,3.529221814864478,4.558584276220095,5.593685619705376,6.510216866181587,7.486967953517443,8.83068735572973,9.554847952123929,0.21231914643484373,1.481945235967224,2.0090300307363904,3.99972772260886,4.069340004442971,5.844519439229508,6.819379079232327,7.96550833512898,8.595895095151342,9.98275409422623,0.2292615331160377,1.8951959475593512,2.8764853274115794,3.0386604857855772,4.104214678192271,5.293869471681283,6.221746863981558,7.544447652641985,8.864036054172026,9.384930573182338,0.8247011215254005,1.078772387436139,2.13903345467255,3.7663536716563257,4.417004770613481,5.922989236714976,6.426274927217342,7.066935940603308,8.925199735722423,9.717400500931682,0.7458387732361516,1.602547307429596,2.126963195235099,3.117506234445692,4.297063548064976,5.03238045344775,6.307357581440634,7.450254245522693,8.114798060946065,9.015200813876582,0.9150805805344007,1.370290096334621,2.7256513750279154,3.8655965778411527,4.218715132618023,5.516207102959662,6.804242807365277,7.210228688372773,8.962979431699374,9.166796335382251,0.8294519289191484,1.6440808424090037,2.0249769256925774,3.897296617493076,4.740668564556778,5.386709490793656,6.070446316418007,7.235644527089072,8.594042793051663,9.938493838276791,0.210011559602286,1.3187243958734243,2.2187349470835542,3.7368858435147203,4.655431864878288,5.54861830945557,6.873165613238449,7.812660219070004,8.375851695785137,9.248856107351195}
-[ RECORD 3 ]-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
id       | 3
pname    | pname 3
pts      | 2024-02-21 06:44:09.078976+09
elemvals | {0.47411373687660685,1.274185896629465,2.5117217929659184,3.7917918548087393,4.110916677782971,5.458171760544051,6.092073491105939,7.9932463831692395,8.992871562449327,9.076916503004473,0.3661460135639665,1.2719144738562456,2.3277393209370167,3.1966557855173825,4.354352878291966,5.948090626267035,6.33139855908863,7.774555445370684,8.850850279023152,9.998624515580136,0.7590955585280064,1.1899614956335292,2.9547870852719917,3.5881709927553267,4.436694276660237,5.7756501251563215,6.601554842334199,7.600440084533634,8.791926346671662,9.349077698570714,0.09403777128673951,1.1694469934373366,2.385641077529872,3.7436307562896083,4.633862768987829,5.210762097769962,6.443055453983707,7.339876014507158,8.852649408076932,9.952760951616288,0.38500413656325705,1.5968103651987668,2.343259936974764,3.467874284842342,4.359189461579863,5.583110876121086,6.191049279883291,7.203838003095402,8.771431441126115,9.50838479081202,0.5051150367857282,1.514943187803997,2.8169177630758533,3.25441952859072,4.9495474834465405,5.1932860961779035,6.011453791084168,7.90643268455759,8.274679571411443,9.00001816120815,0.7227125645874004,1.284322029594282,2.8483369280074022,3.1965959916670137,4.70148479880314,5.4739155103637,6.187087856342632,7.076031372108023,8.612928884730227,9.358221249309995,0.4874933353065991,1.4941412628659556,2.567820889148752,3.1486775446585717,4.157357019570018,5.400797800056839,6.653804554620056,7.916402870416082,8.346975239584854,9.371178295577952,0.46664129948672795,1.123445876370429,2.4803870015843223,3.1370152371078213,4.641460217872609,5.154035388090765,6.786623987582889,7.117846288106225,8.38400807968279,9.845830406927494,0.8309605553762687,1.9522642878141916,2.00189933060361,3.0211701100122674,4.046163738541427,5.029167251253998,6.4358660921026605,7.018323850257989,8.26374324643658,9.019008369229173}
```

139MB から 95MB に減りました

配列ではなく、各要素をカラムにした場合のサイズは配列の時と同じです

```sql
postgres=# CREATE       TABLE   parentonly_ext  (
        id      int8    NOT     NULL,
        pname   text    NOT     NULL,
        pts     timestamptz     NOT     NULL,
        elem_00 float8  NOT     NULL,   elem_01 float8  NOT     NULL,   elem_02 float8  NOT     NULL,   elem_03 float8  NOT     NULL,     elem_04 float8  NOT     NULL,   elem_05 float8  NOT     NULL,   elem_06 float8  NOT     NULL,   elem_07 float8  NOT     NULL,     elem_08 float8  NOT     NULL,   elem_09 float8  NOT     NULL,   elem_10 float8  NOT     NULL,   elem_11 float8  NOT     NULL,     elem_12 float8  NOT     NULL,   elem_13 float8  NOT     NULL,   elem_14 float8  NOT     NULL,   elem_15 float8  NOT     NULL,     elem_16 float8  NOT     NULL,   elem_17 float8  NOT     NULL,   elem_18 float8  NOT     NULL,   elem_19 float8  NOT     NULL,     elem_20 float8  NOT     NULL,   elem_21 float8  NOT     NULL,   elem_22 float8  NOT     NULL,   elem_23 float8  NOT     NULL,     elem_24 float8  NOT     NULL,   elem_25 float8  NOT     NULL,   elem_26 float8  NOT     NULL,   elem_27 float8  NOT     NULL,     elem_28 float8  NOT     NULL,   elem_29 float8  NOT     NULL,   elem_30 float8  NOT     NULL,   elem_31 float8  NOT     NULL,     elem_32 float8  NOT     NULL,   elem_33 float8  NOT     NULL,   elem_34 float8  NOT     NULL,   elem_35 float8  NOT     NULL,     elem_36 float8  NOT     NULL,   elem_37 float8  NOT     NULL,   elem_38 float8  NOT     NULL,   elem_39 float8  NOT     NULL,     elem_40 float8  NOT     NULL,   elem_41 float8  NOT     NULL,   elem_42 float8  NOT     NULL,   elem_43 float8  NOT     NULL,     elem_44 float8  NOT     NULL,   elem_45 float8  NOT     NULL,   elem_46 float8  NOT     NULL,   elem_47 float8  NOT     NULL,     elem_48 float8  NOT     NULL,   elem_49 float8  NOT     NULL,   elem_50 float8  NOT     NULL,   elem_51 float8  NOT     NULL,     elem_52 float8  NOT     NULL,   elem_53 float8  NOT     NULL,   elem_54 float8  NOT     NULL,   elem_55 float8  NOT     NULL,     elem_56 float8  NOT     NULL,   elem_57 float8  NOT     NULL,   elem_58 float8  NOT     NULL,   elem_59 float8  NOT     NULL,     elem_60 float8  NOT     NULL,   elem_61 float8  NOT     NULL,   elem_62 float8  NOT     NULL,   elem_63 float8  NOT     NULL,     elem_64 float8  NOT     NULL,   elem_65 float8  NOT     NULL,   elem_66 float8  NOT     NULL,   elem_67 float8  NOT     NULL,     elem_68 float8  NOT     NULL,   elem_69 float8  NOT     NULL,   elem_70 float8  NOT     NULL,   elem_71 float8  NOT     NULL,     elem_72 float8  NOT     NULL,   elem_73 float8  NOT     NULL,   elem_74 float8  NOT     NULL,   elem_75 float8  NOT     NULL,     elem_76 float8  NOT     NULL,   elem_77 float8  NOT     NULL,   elem_78 float8  NOT     NULL,   elem_79 float8  NOT     NULL,     elem_80 float8  NOT     NULL,   elem_81 float8  NOT     NULL,   elem_82 float8  NOT     NULL,   elem_83 float8  NOT     NULL,     elem_84 float8  NOT     NULL,   elem_85 float8  NOT     NULL,   elem_86 float8  NOT     NULL,   elem_87 float8  NOT     NULL,     elem_88 float8  NOT     NULL,   elem_89 float8  NOT     NULL,   elem_90 float8  NOT     NULL,   elem_91 float8  NOT     NULL,     elem_92 float8  NOT     NULL,   elem_93 float8  NOT     NULL,   elem_94 float8  NOT     NULL,   elem_95 float8  NOT     NULL,     elem_96 float8  NOT     NULL,   elem_97 float8  NOT     NULL,   elem_98 float8  NOT     NULL,   elem_99 float8  NOT     NULL
);
CREATE TABLE
postgres=# DO $_$
    DECLARE
        rec record;
        sql text;
    BEGIN
        FOR rec IN SELECT * FROM parentdetail LOOP
            sql := rec.id || $$,'$$ || rec.pname || $$','$$ || rec.pts || $$',$$;
            sql = sql || array_to_string(rec.elemvals, $$,$$);
            EXECUTE 'INSERT INTO parentonly_ext VALUES(' || sql || ')';
        END LOOP;
    END;
$_$;
DO
postgres=# ALTER TABLE parentonly_ext ADD PRIMARY KEY(id);
CREATE UNIQUE INDEX parentonly_pname ON parentonly_ext(pname, pts);
CREATE INDEX parentonly_pts ON parentonly_ext(pts);
ALTER TABLE
CREATE INDEX
CREATE INDEX
postgres=# VACUUM FREEZE ANALYZE parentonly_ext;
VACUUM
postgres=# SELECT pg_size_pretty(pg_total_relation_size('parentonly_ext'::regclass));
-[ RECORD 1 ]--+------
pg_size_pretty | 95 MB

postgres=# SELECT timeit(
$$
    SELECT count(1) FROM parentonly WHERE id = $1
$$);
-[ RECORD 1 ]-----------
timeit | 00:00:00.000066
```

elemnames 配列がなければタプルのサイズはトーストしきい値をはるかに下回っているため、toast 化されません。アクセス時間はわずかですが遅くなります。
ほとんどの要素に対して分析を実行する場合、または数千の要素を計画している場合は、おそらく配列モデルが最適です

### JSONB データモデル

JSONB は圧縮可能なデータ型なので TOAST の恩恵を受けています

```sql
postgres=# CREATE TABLE parentdetailjsonb (
    id int8 NOT NULL,
    pdoc jsonb
);
CREATE TABLE
postgres=# INSERT INTO parentdetailjsonb
SELECT id, row_to_json(ss)::jsonb
FROM (
    SELECT id, pname, pts,
        jsonb_object(elemnames, elemvals::text[]) AS elements
    FROM parentdetail
    ORDER BY id, pts
) AS ss;

ALTER TABLE parentdetailjsonb ADD PRIMARY KEY(id);
CREATE UNIQUE INDEX parentdetailjsonb_pname
    ON parentdetailjsonb (((pdoc->'pname')::text), ((pdoc->'pts')::text));
CREATE INDEX parentdetailjsonb_pts
    ON parentdetailjsonb (((pdoc->'pts')::text));
CREATE INDEX parentdetailjsonb_pdoc
    ON parentdetailjsonb USING GIN(pdoc);

VACUUM FREEZE ANALYZE;
INSERT 0 100000
ALTER TABLE
CREATE INDEX
CREATE INDEX
CREATE INDEX
VACUUM
postgres=# SELECT pg_size_pretty(pg_total_relation_size('parentdetailjsonb'::regclass));
-[ RECORD 1 ]--+-------
pg_size_pretty | 892 MB

postgres=# SELECT timeit(
$$
    SELECT count(1) FROM parentdetailjsonb WHERE pdoc @> ('{"id": "$1"}')::jsonb;
$$);

 timeit
-[ RECORD 1 ]----------
timeit | 00:00:00.00013
```

JSONB に GIN インデックスを貼るメリットは薄いので削除します

```sql
postgres-# DROP INDEX parentdetailjsonb_pdoc;
ERROR:  syntax error at or near "timeit"
LINE 1: timeit
        ^
postgres=# DROP INDEX parentdetailjsonb_pdoc;

SELECT pg_size_pretty(pg_table_size('parentdetailjsonb'::regclass));
DROP INDEX
-[ RECORD 1 ]--+-------
pg_size_pretty | 271 MB

postgres=# SELECT pg_size_pretty(pg_indexes_size('parentdetailjsonb'::regclass));
-[ RECORD 1 ]--+------
pg_size_pretty | 15 MB

postgres=# SELECT pg_size_pretty(pg_total_relation_size('parentdetailjsonb'::regclass));
-[ RECORD 1 ]--+-------
pg_size_pretty | 285 MB

postgres=# SELECT timeit(
$$
    SELECT count(1) FROM parentdetailjsonb WHERE id = $1
$$);
-[ RECORD 1 ]----------
timeit | 00:00:00.00008
```

元の 2 つのテーブル設計の 29%程度になりました。
