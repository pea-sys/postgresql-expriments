# ベース バックアップと PITR

### ベースバックアップ(物理)

```pwsh
PS C:\Users\user> psql -U postgres -p 5432 -d dvdrental
ユーザー postgres のパスワード:
psql (15.2)
"help"でヘルプを表示します。

dvdrental=# select pg_current_wal_lsn();
 pg_current_wal_lsn
--------------------
 1/73937598
(1 行)
dvdrental=# SELECT pg_backup_start('1/73937598', false) ;
 pg_backup_start
-----------------
 1/74000028
(1 行)

dvdrental=# \! cp -r "C:\Program Files\PostgreSQL\15\data" "E:\backup"
dvdrental=#  SELECT pg_backup_stop(true);
NOTICE:  WAL アーカイブが有効になっていません。バックアップを完了させるには、すべての必要なWALセグメントが他の方法でコピーされたことを確認してください。
                               pg_backup_stop
-----------------------------------------------------------------------------
 (1/74000138,"START WAL LOCATION: 1/74000028 (file 000000010000000100000074)+
 CHECKPOINT LOCATION: 1/74000060                                            +
 BACKUP METHOD: streamed                                                    +
 BACKUP FROM: primary                                                       +
 START TIME: 2023-04-30 18:53:23 JST                                        +
 LABEL: 1/73937598                                                          +
 START TIMELINE: 1                                                          +
 ","16771 E:\\\\dbs                                                         +
 ")
(1 行)

```

| 稼働率    | 稼働率    | 年間停止時間                                                                                                                                                                          | バックアップとリストアの方針 |
| --------- | --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------- |
| 90％      | 36.5 日間 | 月に複数回のメンテナンス時間を設けることができる。論理バックアップや物理バックアップとリストアで十分に対応できる                                                                      |
| 99％      | 3.65 日間 | オンプレミスなら予備のマシンが必要になる。大規模なデータの場合はリストアの所要時間の把握などが必要になる                                                                              |
| 99.9％    | 8.7 時間  | 法定停電や 24 時間 365 日対応などシステム以外の部分にも影響が出る 99.99％ 52 分間バックアップからのリストアだけでは達成が難しいため、コールドスタンバイなど冗長化のしくみが必要になる |
| 99.999％  | 5 分間    | レプリケーションを利用した、すぐに切り替えられる予備サーバ（ホットスタンバイ）や DR（Disaster Recovery）などの専用のしくみが必要になる                                                |
| 99.9999％ | 32 秒間   | 無停止で運用する専用サーバや、大規模な冗長構成のシステムやハードウェアが必要になり、急激にコストが高くなる                                                                            |

(引用:https://gihyo.jp/dev/feature/01/dex_postgresql/0004)
